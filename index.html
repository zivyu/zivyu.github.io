<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="爱生活，爱学习，爱旅行。">
<meta property="og:type" content="website">
<meta property="og:title" content="DanDan的学习笔记">
<meta property="og:url" content="https://zivyu.github.io/index.html">
<meta property="og:site_name" content="DanDan的学习笔记">
<meta property="og:description" content="爱生活，爱学习，爱旅行。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DanDan的学习笔记">
<meta name="twitter:description" content="爱生活，爱学习，爱旅行。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zivyu.github.io/"/>





  <title> DanDan的学习笔记 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ec91f39600049a481c2c32d404e8d3cc";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">DanDan的学习笔记</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2017/01/12/mapreduce-principle-implement-02/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/mapreduce-principle-implement-02/" itemprop="url">
                  MapReduce原理与实现（二）：MapReduce的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-12T14:05:19+08:00">
                2017-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式学习/" itemprop="url" rel="index">
                    <span itemprop="name">分布式学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/12/mapreduce-principle-implement-02/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/12/mapreduce-principle-implement-02/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>在实现MapReduce的过程中，主要是实现一个MapReduce框架。这个框架是干嘛的呢？具体来说，就是使用者只需要定义自己的Map和Reduce方法，即可完成MapReduce功能。</p>
<p>如下所示：</p>
<pre><code>input is divided into &quot;splits&quot;
Input Map -&gt; a,1 b,1 c,1
Input Map -&gt;     b,1
Input Map -&gt; a,1     c,1
            |   |   |
                |   -&gt; Reduce -&gt; c,2
                -----&gt; Reduce -&gt; b,2
</code></pre><p>主要逻辑如下：</p>
<ol>
<li>MR会对每个split来调用Map()，并产生中间结果集k2,v2</li>
<li>对于每个k2，MR会聚合所有与之相对应的中间值v2。然后调用Reduce()</li>
<li>从Reduce()会产生最终的结果集<k2,v3></k2,v3></li>
</ol>
<p>下面看一个具体的例子：word count</p>
<pre><code>input is thousands of text files
Map(k, v)
    split v into words
    for each word w
        emit(w, &quot;1&quot;)
Reduce(k, v)
    emit(len(v))
</code></pre><p>如上图：</p>
<ul>
<li>输入：上千个文本文件</li>
<li>Map(k, v)：将输入v切割成具体的word，对于每个word，发出(w,”1”)</li>
<li>Reduce(k, v)：计算v的长度，然后返回给调用者。</li>
</ul>
<h2 id="MR框架实现"><a href="#MR框架实现" class="headerlink" title="MR框架实现"></a>MR框架实现</h2><p>上面给出了word count的功能，以及用户定义的Map和Reduce方法的作用，从下面开始，我们开始用代码来实现具体的功能。</p>
<p>根据论文描述，MapReduce主要分为两个阶段：<br>Map阶段：</p>
<ol>
<li>分配到map任务的worker会读取对应的输入文件的内容。</li>
<li>将文件内容传递给<em>Map</em>方法。</li>
<li>map方法生成的K/V中间结果会被保存在本地文件中。</li>
</ol>
<p>Reduce阶段：</p>
<ol>
<li>当master通知一个reduce worker这些数据保存的位置时，该worker使用RPC调用来读取本地磁盘保存的数据。</li>
<li>将中间结果按照key进行归类。</li>
<li>将归类后的k/v集合传递给<em>Reduce</em>方法。</li>
<li>得到最终结果。</li>
</ol>
<p>为了实现word count功能。可以由浅入深，分为四个步骤进行：</p>
<ol>
<li>单线程情况下，完成MR最核心的功能，即MR的doMap()和doReduce()方法。</li>
<li>单线程下，完成用户自定义的Map()和Reduce()方法，实现word count功能。</li>
<li>多线程下，会新增master，完成master的schedule()方法，实现word count功能。</li>
<li>实现故障容错。</li>
</ol>
<h3 id="单线程MapReduce"><a href="#单线程MapReduce" class="headerlink" title="单线程MapReduce"></a>单线程MapReduce</h3><p>在单线程情况下，MR首先会执行doMap，然后执行doReduce。</p>
<p>doMap()：被map worker调用，读取一个输入文件，得到文件内容，然后调用用户自定义的map方法，并把map方法返回的结果保存在本地文件中。</p>
<p>doReduce()：被reduce worker调用，读取在map阶段产生的中间结果，并对key进行归类，然后调用用户自定义的reduce方法，得到最终结果。</p>
<p>所以先实现MR框架的doMap()方法，如下：</p>
<p>代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">func doMap(</div><div class="line">	jobName string, // the name of the MapReduce job</div><div class="line">	mapTaskNumber int, // which map task this is</div><div class="line">	inFile string,</div><div class="line">	nReduce int, // the number of reduce task that will be run ("R" in the paper)</div><div class="line">	mapF func(file string, contents string) []KeyValue,</div><div class="line">) &#123;</div><div class="line">	file, err := os.Open(inFile)</div><div class="line">	if err != nil &#123;</div><div class="line">		log.Fatal("read input file: ", err)</div><div class="line">	&#125;</div><div class="line">	inf, err := file.Stat()</div><div class="line">	contents := make([]byte, inf.Size())</div><div class="line">	file.Read(contents)</div><div class="line">	file.Close()</div><div class="line">	kv := mapF(inFile, string(contents)) //让具体的map去执行</div><div class="line">	fileArray := make([]*os.File, nReduce)</div><div class="line">	for i := 0; i &lt; nReduce; i++ &#123;</div><div class="line">		reduceName := reduceName(jobName, mapTaskNumber, i)</div><div class="line">		file, err := os.Create(reduceName) //创建file</div><div class="line">		if err != nil &#123;</div><div class="line">			log.Fatal("create reduce file: ", err)</div><div class="line">		&#125;</div><div class="line">		fileArray[i] = file</div><div class="line">	&#125;</div><div class="line">	for _, v := range kv &#123;</div><div class="line">		key := v.Key</div><div class="line">		enc := json.NewEncoder(fileArray[ihash(key)%uint32(nReduce)])</div><div class="line">		err := enc.Encode(&amp;v)</div><div class="line">		if err != nil &#123;</div><div class="line">			log.Fatal("write reduce file: ", err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	for _, v := range fileArray &#123;</div><div class="line">		v.Close()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后再实现doReduce方法，如下：</p>
<p>代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">func doReduce(</div><div class="line">	jobName string, // the name of the whole MapReduce job</div><div class="line">	reduceTaskNumber int, // which reduce task this is</div><div class="line">	nMap int, // the number of map tasks that were run ("M" in the paper)</div><div class="line">	reduceF func(key string, values []string) string,</div><div class="line">) &#123;</div><div class="line">	keyValueGroup := make(map[string][]string) </div><div class="line">	for i := 0; i &lt; nMap; i++ &#123;</div><div class="line">		reduceName := reduceName(jobName, i, reduceTaskNumber)</div><div class="line">		file, err := os.Open(reduceName)</div><div class="line">		if err != nil &#123;</div><div class="line">			fmt.Printf("reduce file can't open\n")</div><div class="line">		&#125; else &#123;</div><div class="line">			enc := json.NewDecoder(file)</div><div class="line">			for &#123;</div><div class="line">				var kv KeyValue</div><div class="line">				err := enc.Decode(&amp;kv)</div><div class="line">				if err != nil &#123;</div><div class="line">					break</div><div class="line">				&#125;</div><div class="line">				_, ok := keyValueGroup[kv.Key]</div><div class="line">				if !ok &#123;</div><div class="line">					keyValueGroup[kv.Key] = make([]string, 0)</div><div class="line">				&#125;</div><div class="line">				tempArray := keyValueGroup[kv.Key]</div><div class="line">				groupArray := append(tempArray, kv.Value)</div><div class="line">				keyValueGroup[kv.Key] = groupArray</div><div class="line">			&#125;</div><div class="line">			file.Close()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	file, err := os.Create(mergeName(jobName, reduceTaskNumber))</div><div class="line">	if err != nil &#123;</div><div class="line">		log.Fatal("create merge file: ", err)</div><div class="line">	&#125;</div><div class="line">	enc := json.NewEncoder(file)</div><div class="line">	for k := range keyValueGroup &#123;</div><div class="line">		enc.Encode(KeyValue&#123;k, reduceF(k, keyValueGroup[k])&#125;)</div><div class="line">	&#125;</div><div class="line">	file.Close()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="单线程的word-count"><a href="#单线程的word-count" class="headerlink" title="单线程的word count"></a>单线程的word count</h3><p>经过上面的步骤，我们已经完成的MR最核心的两个方法，现在再来自定义具体的map和reduce方法，实现word count功能。</p>
<p>map()：完成文本切分，并返回KeyValue的集合。</p>
<p>reduce()：对每个key的value进行计算。得到最终结果。</p>
<p>map()和reduce()方法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapF</span><span class="params">(document <span class="keyword">string</span>, value <span class="keyword">string</span>)</span> <span class="params">(res []mapreduce.KeyValue)</span></span> &#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> you have to write this function</span></div><div class="line">	<span class="comment">//	words := strings.Fields(value)</span></div><div class="line">	<span class="comment">//	for _, v := range words &#123;</span></div><div class="line">	<span class="comment">//		res = append(res, mapreduce.KeyValue&#123;v, "1"&#125;)</span></div><div class="line">	<span class="comment">//	&#125;</span></div><div class="line">	<span class="comment">//	return</span></div><div class="line">	res = <span class="built_in">make</span>([]mapreduce.KeyValue, <span class="number">0</span>)</div><div class="line">	ss := strings.FieldsFunc(value, <span class="function"><span class="keyword">func</span><span class="params">(c <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> !unicode.IsLetter(c)</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> ss &#123;</div><div class="line">		res = <span class="built_in">append</span>(res, mapreduce.KeyValue&#123;s, <span class="string">"1"</span>&#125;)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceF</span><span class="params">(key <span class="keyword">string</span>, values []<span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="comment">// <span class="doctag">TODO:</span> you also have to write this function</span></div><div class="line">	count := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> values &#123;</div><div class="line">		i64, err := strconv.ParseInt(v, <span class="number">10</span>, <span class="number">32</span>)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">		count = count + <span class="keyword">int</span>(i64)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> strconv.Itoa(count)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="多线程MapReduce"><a href="#多线程MapReduce" class="headerlink" title="多线程MapReduce"></a>多线程MapReduce</h3><p>经过上面的步骤，已经完成的单线程版的word count功能。</p>
<p>但是在多线程的情况下，会有多个worker同时工作，这时候会有一个master来分配和管理。</p>
<p>在不考虑故障容错的情况下，根据论文描述，master主要的职责如下：</p>
<ol>
<li>worker启动时候会注册到master上。</li>
<li>master为空闲的worker分配doMap或者doReduce任务。</li>
</ol>
<p>master的调度主要体现在schedule()方法中：</p>
<p>实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mr *Master)</span> <span class="title">schedule</span><span class="params">(phase jobPhase)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> ntasks <span class="keyword">int</span></div><div class="line">	<span class="keyword">var</span> nios <span class="keyword">int</span> <span class="comment">// number of inputs (for reduce) or outputs (for map)</span></div><div class="line">	<span class="keyword">switch</span> phase &#123;</div><div class="line">	<span class="keyword">case</span> mapPhase:</div><div class="line">		ntasks = <span class="built_in">len</span>(mr.files)</div><div class="line">		nios = mr.nReduce</div><div class="line">	<span class="keyword">case</span> reducePhase:</div><div class="line">		ntasks = mr.nReduce</div><div class="line">		nios = <span class="built_in">len</span>(mr.files)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Printf(<span class="string">"Schedule: %v %v tasks (%d I/Os)\n"</span>, ntasks, phase, nios)</div><div class="line"></div><div class="line">	<span class="comment">// All ntasks tasks have to be scheduled on workers, and only once all of</span></div><div class="line">	<span class="comment">// them have been completed successfully should the function return.</span></div><div class="line">	<span class="comment">// Remember that workers may fail, and that any given worker may finish</span></div><div class="line">	<span class="comment">// multiple tasks.</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	<span class="comment">// TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO TODO</span></div><div class="line">	<span class="comment">//</span></div><div class="line">	fmt.Println(<span class="string">"Start start start"</span>)</div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup <span class="comment">//</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ntasks; i++ &#123;</div><div class="line">		wg.Add(<span class="number">1</span>)</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(taskNum <span class="keyword">int</span>, nios <span class="keyword">int</span>, phase jobPhase)</span></span> &#123;</div><div class="line">			<span class="keyword">defer</span> wg.Done()                </div><div class="line">			worker := &lt;-mr.registerChannel </div><div class="line">			fmt.Println(<span class="string">"DEBUG: current worker port: %v\n"</span>, worker)</div><div class="line"></div><div class="line">			<span class="keyword">var</span> args DoTaskArgs</div><div class="line">			args.JobName = mr.jobName</div><div class="line">			args.File = mr.files[taskNum]</div><div class="line">			args.Phase = phase</div><div class="line">			args.TaskNumber = taskNum</div><div class="line">			args.NumOtherPhase = nios</div><div class="line">			ok := call(worker, <span class="string">"Worker.DoTask"</span>, &amp;args, <span class="built_in">new</span>(<span class="keyword">struct</span>&#123;&#125;))</div><div class="line">			<span class="keyword">if</span> ok &#123;</div><div class="line">				<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">					mr.registerChannel &lt;- worker</div><div class="line">				&#125;()</div><div class="line">			&#125;</div><div class="line">		&#125;(i, nios, phase)</div><div class="line">	&#125;</div><div class="line">	wg.Wait()</div><div class="line"></div><div class="line">	fmt.Printf(<span class="string">"Schedule: %v phase done\n"</span>, phase)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><p>在上面多线程实现中，我们没有考虑worker失败的情况，那么当worker失败该如何处理呢？</p>
<p>在worker执行的过程中，每个worker都是无状态的节点。所以当worker失败的时候，master可以简单的将这个处理失败的任务分配给其他的worker进行处理。</p>
<p>改进schedule()方法，RPC调用每个worker进行处理的时候，如果rpc失败，则将任务分配给其他的worker进行处理，一直到rpc返回ok。</p>
<p>最简单粗暴的方法来实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> &#123;</div><div class="line">	worker := &lt;-mr.registerChannel  <span class="comment">// 获取工作rpc服务器, worker == address</span></div><div class="line">	<span class="keyword">var</span> args DoTaskArgs</div><div class="line">	args.JobName = mr.jobName</div><div class="line">	args.File = mr.files[taskNum]</div><div class="line">	args.Phase = phase</div><div class="line">	args.TaskNumber = taskNum</div><div class="line">	args.NumOtherPhase = nios</div><div class="line">	ok := call(worker, <span class="string">"Worker.DoTask"</span>, &amp;args, <span class="built_in">new</span>(<span class="keyword">struct</span>&#123;&#125;))</div><div class="line">	<span class="keyword">if</span> ok &#123;</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="comment">//doneChannel &lt;- taskNum</span></div><div class="line">			mr.registerChannel &lt;- worker </div><div class="line">		&#125;()</div><div class="line">		<span class="keyword">break</span>  <span class="comment">//执行成功，才结束这个任务。</span></div><div class="line">	&#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2017/01/05/mapreduce-principle-implement-01/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/05/mapreduce-principle-implement-01/" itemprop="url">
                  MapReduce原理与实现（一）：基本原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-05T10:37:08+08:00">
                2017-01-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式学习/" itemprop="url" rel="index">
                    <span itemprop="name">分布式学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/05/mapreduce-principle-implement-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/05/mapreduce-principle-implement-01/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>MapReduce是用来处理大数据的一个编程模型。</p>
<p>用户一般规定了<em>map</em>方法来处理一个k/v对，而<em>reduce</em>方法来合并相关的中间值。</p>
<h2 id="Programming-Model"><a href="#Programming-Model" class="headerlink" title="Programming Model"></a>Programming Model</h2><p>计算任务以k/v对的集合作为<em>输入</em>，并产生另外的k/v集合作为<em>输出</em>。用户通过<em>Map</em>和<em>Reduce</em>方法来控制计算。</p>
<p><em>Map</em>，接受一个k/v对为输入，并产生<em>中间的</em>k/v集合。MapReduce将会以相同的中间的key <em>I</em>来聚合所有相关的值，并把这个集合传递给<em>Reduce</em>方法。</p>
<p><em>Reduce</em>，接受key <em>I</em>和相关的值，它将这些值进行合并，从而形成一个更小的集合。通常每次Reduce调用会有0到1个输出。</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>现在我们来统计一个大型文档中的每个单词出现的次数。伪代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">map</span>(String key, String value):</div><div class="line">	<span class="comment">// key: document name</span></div><div class="line">	<span class="comment">// value: document contents</span></div><div class="line">	<span class="keyword">for</span> each word w in value:</div><div class="line">		EmitIntermediate(w, <span class="string">"1"</span>);</div><div class="line"></div><div class="line">reduce(String key, Iterator values):</div><div class="line">	<span class="comment">// key: a word</span></div><div class="line">	<span class="comment">// values: a list of counts</span></div><div class="line">	<span class="keyword">int</span> result = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> each v in values:</div><div class="line">		result += ParseInt(v);</div><div class="line">	Emit(AsString(result));</div></pre></td></tr></table></figure>
<p>map方法发出每个单词出现的次数。reduce方法聚合一个单词所有的结果。</p>
<h3 id="Types"><a href="#Types" class="headerlink" title="Types"></a>Types</h3><p>用户提供的map和reduce方法大概如下：</p>
<pre><code>map (k1,v1) ! list(k2,v2)
reduce (k2,list(v2)) ! list(v2)
</code></pre><h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><h3 id="Execution-Overview"><a href="#Execution-Overview" class="headerlink" title="Execution Overview"></a>Execution Overview</h3><p>本节描述了在Google广泛使用的一个实现。</p>
<p><img src="/images/mapreduce_implement_01.png" alt=""></p>
<p>如上图，描述了一个MapReduce操作的整体流程。当一个用户程序调用<code>MapReduce</code>方法，将会发生下列动作：</p>
<ol>
<li>MapReduce库首先将会把输入文件切分成M份，每份的大小通常为16M到64M。然后在集群中启动程序。</li>
<li>其中有一个程序是master，其余的为workers。workers由master分配任务。总共会分配M个map和R个reduce任务。master会挑选空闲的worker，并给他们分配map或者reduce任务。</li>
<li>分配到map任务的worker会读取对应的输入文件的内容。解析出输入数据的k/v对，然后传递给<em>Map</em>方法。map方法生成的K/V中间结果会在内存中缓存。</li>
<li>缓存中的数据将会定期被写到本地磁盘上，并划分为R个部分。这些数据保存的位置会被通知给master。</li>
<li>当master通知一个reduce worker这些数据保存的位置时，该worker使用RPC调用来读取本地磁盘保存的数据。当reduce worker读取完所有的中间结果时，它会根据key来排序。</li>
<li>reduce worker迭代所有中间结果，对于每个独一无二的key，它将与这个key对应的集合数据传递给用户定义的<em>Reduce</em>方法。reduce输出的结果会被追加到结果文件中。</li>
<li>当所有的map和reduce任务完成，mater唤醒用户程序。然后<code>MapReduce</code>调用返回结果。</li>
</ol>
<p>在成功完成之后，mapreduce的执行结果可能会在R个输出文件中。用户通常不需要合并这R个文件，因为，可以把它们作为新的MapReduce的输入数据，或者在别的分布式系统中使用它们。</p>
<h3 id="Master-Data-Structures"><a href="#Master-Data-Structures" class="headerlink" title="Master Data Structures"></a>Master Data Structures</h3><h3 id="Fault-Tolerance"><a href="#Fault-Tolerance" class="headerlink" title="Fault Tolerance"></a>Fault Tolerance</h3><h3 id="Locality"><a href="#Locality" class="headerlink" title="Locality"></a>Locality</h3><h3 id="Task-Granularity"><a href="#Task-Granularity" class="headerlink" title="Task Granularity"></a>Task Granularity</h3><h3 id="Backup-Tasks"><a href="#Backup-Tasks" class="headerlink" title="Backup Tasks"></a>Backup Tasks</h3><h2 id="Refinements"><a href="#Refinements" class="headerlink" title="Refinements"></a>Refinements</h2><h3 id="Partitioning-Function"><a href="#Partitioning-Function" class="headerlink" title="Partitioning Function"></a>Partitioning Function</h3><h3 id="Ordering-Guarantees"><a href="#Ordering-Guarantees" class="headerlink" title="Ordering Guarantees"></a>Ordering Guarantees</h3><h3 id="Combiner-Function"><a href="#Combiner-Function" class="headerlink" title="Combiner Function"></a>Combiner Function</h3><h3 id="Input-and-Output-Types"><a href="#Input-and-Output-Types" class="headerlink" title="Input and Output Types"></a>Input and Output Types</h3><h3 id="Side-effects"><a href="#Side-effects" class="headerlink" title="Side-effects"></a>Side-effects</h3><h3 id="Skipping-Bad-Records"><a href="#Skipping-Bad-Records" class="headerlink" title="Skipping Bad Records"></a>Skipping Bad Records</h3><h3 id="Local-Execution"><a href="#Local-Execution" class="headerlink" title="Local Execution"></a>Local Execution</h3><h3 id="Status-Information"><a href="#Status-Information" class="headerlink" title="Status Information"></a>Status Information</h3><h3 id="Counters"><a href="#Counters" class="headerlink" title="Counters"></a>Counters</h3><h2 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h2><p>略</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2017/01/03/tour-of-go-02/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/03/tour-of-go-02/" itemprop="url">
                  A Tour of Go（二）：方法和接口
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-03T19:27:26+08:00">
                2017-01-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go语言/" itemprop="url" rel="index">
                    <span itemprop="name">Go语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/03/tour-of-go-02/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/03/tour-of-go-02/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本节我们主要学习怎么定义方法、怎么声明接口，等。</p>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>Go语言没有类，但是我们可以在类型上定义方法。</p>
<p>方法有一个特殊的<em>接受者</em>参数的函数。</p>
<p>接受者出现在<code>func</code>关键字和方法名之间的参数列表中。</p>
<p>比如说下面的例子，方法<code>Abs</code>有一个类型为<code>Vertex</code>的接受者。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	fmt.Println(v.Abs())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方法及函数"><a href="#方法及函数" class="headerlink" title="方法及函数"></a>方法及函数</h3><p>方法仅仅是一个有接收者参数的函数。</p>
<p>可以把方法重写为一个函数，如下乳，<code>Abs</code>可以被写为一个常规的方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Abs</span><span class="params">(v Vertex)</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	fmt.Println(Abs(v))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方法（续）"><a href="#方法（续）" class="headerlink" title="方法（续）"></a>方法（续）</h3><p>也可以为non-struct类型声明方法，</p>
<p>看下面的例子，数值类型<code>MyFloat</code>有一个<code>Abs</code>方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> MyFloat <span class="keyword">float64</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f MyFloat)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">float64</span>(-f)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">float64</span>(f)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	f := MyFloat(-math.Sqrt2)</div><div class="line">	fmt.Println(f.Abs())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="指针接收者"><a href="#指针接收者" class="headerlink" title="指针接收者"></a>指针接收者</h3><p>可以声明方法的接收者是指针。</p>
<p>看下面的例子，<code>Scale</code>方法定义在<code>*Vertex</code>之上。</p>
<p>这样可以修改接收者的值，如果不传指针，则是原始对象的一个拷贝。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Scale</span><span class="params">(f <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	v.X = v.X * f</div><div class="line">	v.Y = v.Y * f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	v.Scale(<span class="number">10</span>)</div><div class="line">	fmt.Println(v.Abs())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="指针和函数"><a href="#指针和函数" class="headerlink" title="指针和函数"></a>指针和函数</h3><p>也可以把方法重写成一个函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Abs</span><span class="params">(v Vertex)</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Scale</span><span class="params">(v Vertex, f <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	v.X = v.X * f</div><div class="line">	v.Y = v.Y * f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	Scale(v, <span class="number">10</span>)</div><div class="line">	fmt.Println(Abs(v))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方法和间接指针"><a href="#方法和间接指针" class="headerlink" title="方法和间接指针"></a>方法和间接指针</h3><p>在之前的例子中，有一个指针参数的方法比如传入一个指针：</p>
<pre><code>var v Vertex
ScaleFunc(v)  // Compile error!
ScaleFunc(&amp;v) // OK
</code></pre><p>而调用指针接收者的方法的时候，既不需要传入值也不需要传入指针：</p>
<pre><code>var v Vertex
v.Scale(5)  // OK
p := &amp;v
p.Scale(10) // OK
</code></pre><p>对于语句<code>v.Scale(5)</code>，会自动调用有指针接收者的方法。比如说，<code>v.Scale(5)</code>会变为<code>(&amp;v).Scale(5)</code>，因为<code>Scale</code>方法有一个指针接收者：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Scale</span><span class="params">(f <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	v.X = v.X * f</div><div class="line">	v.Y = v.Y * f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ScaleFunc</span><span class="params">(v *Vertex, f <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	v.X = v.X * f</div><div class="line">	v.Y = v.Y * f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	v.Scale(<span class="number">2</span>)</div><div class="line">	ScaleFunc(&amp;v, <span class="number">10</span>)</div><div class="line"></div><div class="line">	p := &amp;Vertex&#123;<span class="number">4</span>, <span class="number">3</span>&#125;</div><div class="line">	p.Scale(<span class="number">3</span>)</div><div class="line">	ScaleFunc(p, <span class="number">8</span>)</div><div class="line"></div><div class="line">	fmt.Println(v, p)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="选择值接收者还是指针接收者"><a href="#选择值接收者还是指针接收者" class="headerlink" title="选择值接收者还是指针接收者"></a>选择值接收者还是指针接收者</h3><p>选择指针接收者有两个原因：</p>
<p>第一个原因是可以修改接收者指针的值。</p>
<p>第二个原因避免每次调用的时候复制值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Scale</span><span class="params">(f <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	v.X = v.X * f</div><div class="line">	v.Y = v.Y * f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := &amp;Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	fmt.Printf(<span class="string">"Before scaling: %+v, Abs: %v\n"</span>, v, v.Abs())</div><div class="line">	v.Scale(<span class="number">5</span>)</div><div class="line">	fmt.Printf(<span class="string">"After scaling: %+v, Abs: %v\n"</span>, v, v.Abs())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p><em>接口类型</em>是一组方法签名的集合。</p>
<p>接口类型的值可以存放实现这些方法的任何值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Abser <span class="keyword">interface</span> &#123;</div><div class="line">	Abs() <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> a Abser</div><div class="line">	f := MyFloat(-math.Sqrt2)</div><div class="line">	v := Vertex&#123;<span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line"></div><div class="line">	a = f  <span class="comment">// a MyFloat implements Abser</span></div><div class="line">	a = &amp;v <span class="comment">// a *Vertex implements Abser</span></div><div class="line"></div><div class="line">	<span class="comment">// In the following line, v is a Vertex (not *Vertex)</span></div><div class="line">	<span class="comment">// and does NOT implement Abser.</span></div><div class="line">	a = v</div><div class="line"></div><div class="line">	fmt.Println(a.Abs())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> MyFloat <span class="keyword">float64</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f MyFloat)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">float64</span>(-f)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">float64</span>(f)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X, Y <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *Vertex)</span> <span class="title">Abs</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> math.Sqrt(v.X*v.X + v.Y*v.Y)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="接口的隐式实现"><a href="#接口的隐式实现" class="headerlink" title="接口的隐式实现"></a>接口的隐式实现</h3><p>一个类型通过实现接口的方法来实现一个接口。不需要显示的声明，也没有”implements”关键字。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> I <span class="keyword">interface</span> &#123;</div><div class="line">	M()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> T <span class="keyword">struct</span> &#123;</div><div class="line">	S <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This method means type T implements the interface I,</span></div><div class="line"><span class="comment">// but we don't need to explicitly declare that it does so.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t T)</span> <span class="title">M</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(t.S)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> i I = T&#123;<span class="string">"hello"</span>&#125;</div><div class="line">	i.M()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="空接口"><a href="#空接口" class="headerlink" title="空接口"></a>空接口</h3><p>空接口没有指定任何方法：</p>
<pre><code>interface{}
</code></pre><p>一个空接口可以存储任何类型的值。</p>
<p>空接口用来编写处理未知类型的值。比如说<code>fmt.Print</code> 处理许多<code>interface{}</code>的参数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> i <span class="keyword">interface</span>&#123;&#125;</div><div class="line">	describe(i)</div><div class="line"></div><div class="line">	i = <span class="number">42</span></div><div class="line">	describe(i)</div><div class="line"></div><div class="line">	i = <span class="string">"hello"</span></div><div class="line">	describe(i)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">describe</span><span class="params">(i <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"(%v, %T)\n"</span>, i, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h3><p><em>类型断言</em></p>
<pre><code>t := i.(T)
</code></pre><p>上述语言断言接口值<code>i</code>保存了具体的类型<code>T</code>，并把具体<code>T</code>的值分配给变量<code>t</code>。</p>
<p>但是如果<code>i</code>没有保存一个<code>T</code>，上述的语句会出现错误。</p>
<p>为了<code>测试</code>一个接口值是否保存了一个具体的类型，类型断言可以返回两个值：具体的类型值和断言是否成功。</p>
<pre><code>t, ok := i.(T)
</code></pre><p>如果<code>i</code>保存着<code>T</code>，然后<code>t</code>将会是具体的值，<code>ok</code>将会是true。</p>
<p>反之，<code>ok</code>将是false，<code>t</code>将会是类型<code>T</code>的零值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> i <span class="keyword">interface</span>&#123;&#125; = <span class="string">"hello"</span></div><div class="line"></div><div class="line">	s := i.(<span class="keyword">string</span>)</div><div class="line">	fmt.Println(s)</div><div class="line"></div><div class="line">	s, ok := i.(<span class="keyword">string</span>)</div><div class="line">	fmt.Println(s, ok)</div><div class="line"></div><div class="line">	f, ok := i.(<span class="keyword">float64</span>)</div><div class="line">	fmt.Println(f, ok)</div><div class="line"></div><div class="line">	f = i.(<span class="keyword">float64</span>) <span class="comment">// panic</span></div><div class="line">	fmt.Println(f)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="类型switches"><a href="#类型switches" class="headerlink" title="类型switches"></a>类型switches</h3><p>类型转换就像常规的转换语句一样，但是case是具体的类型而不是值。</p>
<pre><code>switch v := i.(type) {
case T:
    // here v has type T
case S:
    // here v has type S
default:
    // no match; here v has the same type as i
}
</code></pre><h3 id="Stringers"><a href="#Stringers" class="headerlink" title="Stringers"></a>Stringers</h3><p>最普通的接口之一是<code>Stringer</code></p>
<pre><code>type Stringer interface {
    String() string
}
</code></pre><p>一个<code>Stringer</code>是一个可以把它自己描述为一个字符串的类型。<code>fmt</code>包寻找这个接口来打印值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name <span class="keyword">string</span></div><div class="line">	Age  <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v (%v years)"</span>, p.Name, p.Age)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	a := Person&#123;<span class="string">"Arthur Dent"</span>, <span class="number">42</span>&#125;</div><div class="line">	z := Person&#123;<span class="string">"Zaphod Beeblebrox"</span>, <span class="number">9001</span>&#125;</div><div class="line">	fmt.Println(a, z)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><p>Go程序使用<code>error</code>值来表达错误状态。</p>
<p><code>error</code>类型是内建接口。</p>
<pre><code>type error interface {
    Error() string
}
</code></pre><p>函数经常返回一个<code>error</code>值，调用程序通过调用error是否等于<code>nil</code>来处理错误。</p>
<pre><code>i, err := strconv.Atoi(&quot;42&quot;)
if err != nil {
    fmt.Printf(&quot;couldn&apos;t convert number: %v\n&quot;, err)
    return
}
fmt.Println(&quot;Converted integer:&quot;, i)
</code></pre><p>一个nil的<code>error</code>表示成功，一个non-nil的<code>error</code>表示失败。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span> &#123;</div><div class="line">	When time.Time</div><div class="line">	What <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *MyError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"at %v, %s"</span>,</div><div class="line">		e.When, e.What)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;MyError&#123;</div><div class="line">		time.Now(),</div><div class="line">		<span class="string">"it didn't work"</span>,</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err := run(); err != <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2016/12/30/tour-of-go-01/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/30/tour-of-go-01/" itemprop="url">
                  A Tour of Go（一）：基本知识
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-30T10:29:39+08:00">
                2016-12-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Go语言/" itemprop="url" rel="index">
                    <span itemprop="name">Go语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/30/tour-of-go-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/30/tour-of-go-01/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在正式开始Mit 6.824之前，我先按照<a href="https://golang.org/doc/#go_tour" target="_blank" rel="external">A Tour of Go</a> ，学习Go语言的语法和相关知识。</p>
<p>A Tour of Go分为三个章节。第一个章节描述了基本的语法和数据结构，第二个章节讨论了方法和接口，第三个章节介绍了Go语言的并发原语。</p>
<p>本节描述了Go语言的一些基本知识。包括变量声明，方法调用，以及一些其他的知识。</p>
<h2 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello,world!"></a>Hello,world!</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Hello, 世界"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="包，变量和方法"><a href="#包，变量和方法" class="headerlink" title="包，变量和方法"></a>包，变量和方法</h2><h3 id="包"><a href="#包" class="headerlink" title="包"></a>包</h3><p>每个Go程序都由包组成。程序由<code>main</code>包处开始运行。比如说下面的程序使用导入的包”fmt”和”math/rand”。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math/rand"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"My favorite number is"</span>, rand.Intn(<span class="number">10</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h3><p>略</p>
<h3 id="Exported-names"><a href="#Exported-names" class="headerlink" title="Exported names"></a>Exported names</h3><p>在Go中，如果一个单词是以大写字母开头，它就是exported name。比如说Pizza是一个exported name，Pi是一个来自<code>math</code>包的exported name。</p>
<p>如下图，直接使用<code>math</code>包中的Pi</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(math.Pi)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>一个方法可以有一个或多个参数。</p>
<p>注意类型在变量名之后。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">int</span>, y <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> x + y</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(add(<span class="number">42</span>, <span class="number">13</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当两个或多个参数都是同一个类型的时候，可以只保留最后一个类型。</p>
<p>比如说把<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">x <span class="keyword">int</span>, y <span class="keyword">int</span></div></pre></td></tr></table></figure></p>
<p>写成<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">x, y <span class="keyword">int</span></div></pre></td></tr></table></figure></p>
<h3 id="多个返回结果"><a href="#多个返回结果" class="headerlink" title="多个返回结果"></a>多个返回结果</h3><p>一个方法可以返回多个结果。如下，swap返回两个字符串。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(x, y <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> y, x</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	a, b := swap(<span class="string">"hello"</span>, <span class="string">"world"</span>)</div><div class="line">	fmt.Println(a, b)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="命令返回值"><a href="#命令返回值" class="headerlink" title="命令返回值"></a>命令返回值</h3><p>Go的返回值可以被命令，就像在方法中命令变量一样。如下图，命令了返回值为x和y.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">split</span><span class="params">(sum <span class="keyword">int</span>)</span> <span class="params">(x, y <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	x = sum * <span class="number">4</span> / <span class="number">9</span></div><div class="line">	y = sum - x</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(split(<span class="number">17</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>可以用<code>var</code>来声明一个变量列表。类型在后面。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> c, python, java <span class="keyword">bool</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> i <span class="keyword">int</span></div><div class="line">	fmt.Println(i, c, python, java)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="变量初始化"><a href="#变量初始化" class="headerlink" title="变量初始化"></a>变量初始化</h3><p>一个<code>var</code>声明可以包含初始化，每个变量对应一个。</p>
<p>如果变量被初始化了，类型可以省略，</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> i, j <span class="keyword">int</span> = <span class="number">1</span>, <span class="number">2</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> c, python, java = <span class="literal">true</span>, <span class="literal">false</span>, <span class="string">"no!"</span></div><div class="line">	fmt.Println(i, j, c, python, java)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="声明短变量"><a href="#声明短变量" class="headerlink" title="声明短变量"></a>声明短变量</h3><p>在一个方法中，<code>:=</code>语句可以代替一个<code>var</code>声明。而在方法之外，<code>:=</code>是不可用的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> i, j <span class="keyword">int</span> = <span class="number">1</span>, <span class="number">2</span></div><div class="line">	k := <span class="number">3</span></div><div class="line">	c, python, java := <span class="literal">true</span>, <span class="literal">false</span>, <span class="string">"no!"</span></div><div class="line"></div><div class="line">	fmt.Println(i, j, k, c, python, java)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h3><p>Go的基本类型有：</p>
<pre><code>bool

string

int  int8  int16  int32  int64
uint uint8 uint16 uint32 uint64 uintptr

byte 

rune 

float32 float64

complex64 complex128
</code></pre><p><code>int</code>,<code>uint</code>,<code>uintptr</code>的宽度和系统是一样的。当你需要一个整型值，应该使用<code>int</code>。除非有特别的理由来使用一个定长的或无符号的整数类型。</p>
<h3 id="零值"><a href="#零值" class="headerlink" title="零值"></a>零值</h3><p>当变量被声明而没被显示的初始化的时候，这些变量会被初始化为<em>零值</em>。</p>
<p>数值类型为<code>0</code></p>
<p>布尔类型为<code>false</code></p>
<p>字符串为<code>&quot;&quot;</code></p>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><p>表达式<code>T(v)</code>将<code>v</code>转换为类型<code>T</code>。</p>
<p>一些数值类型的转换：</p>
<pre><code>var i int = 42
var f float64 = float64(i)
var u uint = uint(f)
</code></pre><p>也可以有更简单的写法：</p>
<pre><code>i := 42
f := float64(i)
u := uint(f)
</code></pre><h3 id="类型推测"><a href="#类型推测" class="headerlink" title="类型推测"></a>类型推测</h3><p>当声明一个变量而没有显示的指定类型的时候，会从右侧的值推测出变量的类型。</p>
<p>当右边的值已经被指定类型，这个新的变量就是同样的类型。</p>
<pre><code>var i int
j := i // j is an int
</code></pre><p>但是右边是没有类型的数值常量，新的变量可能是<code>int</code>,<code>float64</code>,或<code>complex128</code>，这取决于常量的精度：</p>
<pre><code>i := 42           // int
f := 3.142        // float64
g := 0.867 + 0.5i // complex128
</code></pre><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>常量声明和普通变量一样，但是要带上<code>const</code>关键字。</p>
<p>常量可以是字符、字符串、布尔类型、或数值类型的值。</p>
<p>常量声明不能使用<code>:=</code>语法。</p>
<h3 id="数值常量"><a href="#数值常量" class="headerlink" title="数值常量"></a>数值常量</h3><p>数值常量是高精度的值。</p>
<p>一个没有类型的常量会根据上下文来决定类型。</p>
<h2 id="流程控制语句"><a href="#流程控制语句" class="headerlink" title="流程控制语句"></a>流程控制语句</h2><h3 id="For"><a href="#For" class="headerlink" title="For"></a>For</h3><p>Go语言只有一个循环结构，就是<code>for</code>循环。</p>
<p>for循环有三个用分号隔开的成分：</p>
<pre><code>初始化语句：在第一次开始循环之前被执行。

条件表达式：每次开始循环的时候被求值。

post语句：每次循环结束的时候执行。
</code></pre><p>一旦条件表达式是<code>false</code>，循环将会停止。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	sum := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">		sum += i</div><div class="line">	&#125;</div><div class="line">	fmt.Println(sum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化和post语句都是可以被省略的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	sum := <span class="number">1</span></div><div class="line">	<span class="keyword">for</span> ; sum &lt; <span class="number">1000</span>; &#123;</div><div class="line">		sum += sum</div><div class="line">	&#125;</div><div class="line">	fmt.Println(sum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Go中的”while”"><a href="#Go中的”while”" class="headerlink" title="Go中的”while”"></a>Go中的”while”</h3><p>当去掉分号的时候，<code>for</code>就是C语言中的<code>while</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	sum := <span class="number">1</span></div><div class="line">	<span class="keyword">for</span> sum &lt; <span class="number">1000</span> &#123;</div><div class="line">		sum += sum</div><div class="line">	&#125;</div><div class="line">	fmt.Println(sum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="无限循环"><a href="#无限循环" class="headerlink" title="无限循环"></a>无限循环</h3><p>当省略掉条件表达式的时候，for循环就变成了无限循环。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="If语句"><a href="#If语句" class="headerlink" title="If语句"></a>If语句</h3><p>Go中if和for循环差不多，表达式都不需要被”()”括起来。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sqrt</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> x &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> sqrt(-x) + <span class="string">"i"</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> fmt.Sprint(math.Sqrt(x))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(sqrt(<span class="number">2</span>), sqrt(<span class="number">-4</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="If中的表达式"><a href="#If中的表达式" class="headerlink" title="If中的表达式"></a>If中的表达式</h3><p>像<code>For</code>一样，<code>if</code>可以在执行判断条件之前执行一个简单的语句。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pow</span><span class="params">(x, n, lim <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> v := math.Pow(x, n); v &lt; lim &#123;</div><div class="line">		<span class="keyword">return</span> v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> lim</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(</div><div class="line">		pow(<span class="number">3</span>, <span class="number">2</span>, <span class="number">10</span>),</div><div class="line">		pow(<span class="number">3</span>, <span class="number">3</span>, <span class="number">20</span>),</div><div class="line">	)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="if-and-else"><a href="#if-and-else" class="headerlink" title="if and else"></a>if and else</h3><p>在<code>if</code>中声明的变量，在<code>else</code>中也有用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pow</span><span class="params">(x, n, lim <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> v := math.Pow(x, n); v &lt; lim &#123;</div><div class="line">		<span class="keyword">return</span> v</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"%g &gt;= %g\n"</span>, v, lim)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// can't use v here, though</span></div><div class="line">	<span class="keyword">return</span> lim</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(</div><div class="line">		pow(<span class="number">3</span>, <span class="number">2</span>, <span class="number">10</span>),</div><div class="line">		pow(<span class="number">3</span>, <span class="number">3</span>, <span class="number">20</span>),</div><div class="line">	)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Switch-以及-Switch的执行顺序"><a href="#Switch-以及-Switch的执行顺序" class="headerlink" title="Switch 以及 Switch的执行顺序"></a>Switch 以及 Switch的执行顺序</h3><p>Switch 从上到下依次执行，当条件满足的时候停止。</p>
<p>比如说：</p>
<pre><code>switch i {
case 0:
case f():
}
</code></pre><p>如果i==0，不会调用f。</p>
<h3 id="没有条件的Switch"><a href="#没有条件的Switch" class="headerlink" title="没有条件的Switch"></a>没有条件的Switch</h3><p>没有条件的Switch就和<code>Switch true</code>是一样的。</p>
<h3 id="Defer"><a href="#Defer" class="headerlink" title="Defer"></a>Defer</h3><p>一个defer语句推迟方法的执行直到方法返回。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> fmt.Println(<span class="string">"world"</span>)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"hello"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="defer栈"><a href="#defer栈" class="headerlink" title="defer栈"></a>defer栈</h3><p>defer方法调用被压入到栈中，当方法返回的时候，defer调用按照后进先出的顺序被执行。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"counting"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">		<span class="keyword">defer</span> fmt.Println(i)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"done"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="更多的类型：structs，slices，和maps"><a href="#更多的类型：structs，slices，和maps" class="headerlink" title="更多的类型：structs，slices，和maps"></a>更多的类型：structs，slices，和maps</h2><h3 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h3><p>Go拥有指针。一个指针是一个变量的内存地址。</p>
<p>类型<code>*T</code>是指向值<code>T</code>的一个指针。它的零值是<code>nil</code>。</p>
<pre><code>var p *int
</code></pre><p><code>&amp;</code>操作符会生成一个指向它的操作数的指针。</p>
<pre><code>i := 42
p = &amp;i
</code></pre><p><code>*</code>操作符表示指针的底层的值。</p>
<pre><code>fmt.Println(*p) // 通过指针p读取i的值
*p = 21         // 通过指针p给i设置值
</code></pre><p>但是Go没有指针运算。</p>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><p>一个<code>struct</code>是字段的一个集合。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X <span class="keyword">int</span></div><div class="line">	Y <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="结构体字段"><a href="#结构体字段" class="headerlink" title="结构体字段"></a>结构体字段</h3><p>通过点号来访问结构体字段。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X <span class="keyword">int</span></div><div class="line">	Y <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</div><div class="line">	v.X = <span class="number">4</span></div><div class="line">	fmt.Println(v.X)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="指向结构体的指针"><a href="#指向结构体的指针" class="headerlink" title="指向结构体的指针"></a>指向结构体的指针</h3><p>可以通过结构体指针来访问结构体字段。</p>
<p>可以通过<code>(*p).X</code>来访问一个结构体的字段<code>X</code>。但是这样写很笨重，所以可以直接写<code>p.X</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	X <span class="keyword">int</span></div><div class="line">	Y <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	v := Vertex&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</div><div class="line">	p := &amp;v</div><div class="line">	p.X = <span class="number">1e9</span></div><div class="line">	fmt.Println(v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>类型<code>[n]T</code>是一个有n个类型为T的值的数组。</p>
<p>表达式像下面这样：</p>
<pre><code>var a [10]int
</code></pre><p>上面的语法声明有10个整型的数组。</p>
<p>数组不能改变大小。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> a [<span class="number">2</span>]<span class="keyword">string</span></div><div class="line">	a[<span class="number">0</span>] = <span class="string">"Hello"</span></div><div class="line">	a[<span class="number">1</span>] = <span class="string">"World"</span></div><div class="line">	fmt.Println(a[<span class="number">0</span>], a[<span class="number">1</span>])</div><div class="line">	fmt.Println(a)</div><div class="line"></div><div class="line">	primes := [<span class="number">6</span>]<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>&#125;</div><div class="line">	fmt.Println(primes)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Slices"><a href="#Slices" class="headerlink" title="Slices"></a>Slices</h3><p>Slices是一个固定大小的数组。另一方面，slice是一个数组的动态大小的、灵活的视图。实际上，Slices比数组更通用。</p>
<p>类型<code>[]T</code>是类型T的一个元素的一个slice。</p>
<p>下面的表达式创建了数组a的前五个元素的一个slice：</p>
<pre><code>a[0:5]
</code></pre><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	primes := [<span class="number">6</span>]<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> s []<span class="keyword">int</span> = primes[<span class="number">1</span>:<span class="number">4</span>]</div><div class="line">	fmt.Println(s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Slices-就像是数组的引用"><a href="#Slices-就像是数组的引用" class="headerlink" title="Slices 就像是数组的引用"></a>Slices 就像是数组的引用</h3><p>一个slice本身不存储任何数据，仅仅描述了一个数组的一部分。</p>
<p>更新一个slice的元素相当于更新数组。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	names := [<span class="number">4</span>]<span class="keyword">string</span>&#123;</div><div class="line">		<span class="string">"John"</span>,</div><div class="line">		<span class="string">"Paul"</span>,</div><div class="line">		<span class="string">"George"</span>,</div><div class="line">		<span class="string">"Ringo"</span>,</div><div class="line">	&#125;</div><div class="line">	fmt.Println(names)</div><div class="line"></div><div class="line">	a := names[<span class="number">0</span>:<span class="number">2</span>]</div><div class="line">	b := names[<span class="number">1</span>:<span class="number">3</span>]</div><div class="line">	fmt.Println(a, b)</div><div class="line"></div><div class="line">	b[<span class="number">0</span>] = <span class="string">"XXX"</span></div><div class="line">	fmt.Println(a, b)</div><div class="line">	fmt.Println(names)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="默认Slice"><a href="#默认Slice" class="headerlink" title="默认Slice"></a>默认Slice</h3><p>当进行切片的时候，可以省略最高和最低的界限值。</p>
<p>对于数组</p>
<pre><code>var a [10]int
</code></pre><p>下面的表达式都是相等的：</p>
<pre><code>a[0:10]
a[:10]
a[0:]
a[:]
</code></pre><h3 id="Slice的长度和容量"><a href="#Slice的长度和容量" class="headerlink" title="Slice的长度和容量"></a>Slice的长度和容量</h3><p>一个slice既有<em>长度</em>和<em>容量</em>。</p>
<p>长度就是slice包含的元素个数。</p>
<p>容量是数组元素的个数，从slice中的第一个元素开始计数。</p>
<p>一个slice<code>S</code>的长度和容量可以使用表达式<code>len(s)</code>和<code>cap(s)</code>来获取。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	s := []<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>&#125;</div><div class="line">	printSlice(s)</div><div class="line"></div><div class="line">	<span class="comment">// Slice the slice to give it zero length.</span></div><div class="line">	s = s[:<span class="number">0</span>]</div><div class="line">	printSlice(s)</div><div class="line"></div><div class="line">	<span class="comment">// Extend its length.</span></div><div class="line">	s = s[:<span class="number">4</span>]</div><div class="line">	printSlice(s)</div><div class="line"></div><div class="line">	<span class="comment">// Drop its first two values.</span></div><div class="line">	s = s[<span class="number">2</span>:]</div><div class="line">	printSlice(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"len=%d cap=%d %v\n"</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Nil-slices"><a href="#Nil-slices" class="headerlink" title="Nil slices"></a>Nil slices</h3><p>一个slice的零值是<code>nil</code>。</p>
<p>一个nil slice的长度和容量为0，没有对应的数组。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> s []<span class="keyword">int</span></div><div class="line">	fmt.Println(s, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</div><div class="line">	<span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"nil!"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用make方法创建一个slice"><a href="#使用make方法创建一个slice" class="headerlink" title="使用make方法创建一个slice"></a>使用make方法创建一个slice</h3><p>可以使用<code>make</code>方法创建Slices，这就是创建一个动态大小数组的方式。</p>
<p><code>make</code>方法分配一个零值的数组，然后返回一个slice指向这个数组。</p>
<pre><code>a := make([]int, 5)  // len(a)=5
</code></pre><p>传入第三个参数来指定容量：</p>
<pre><code>b := make([]int, 0, 5) // len(b)=0, cap(b)=5

b = b[:cap(b)] // len(b)=5, cap(b)=5
b = b[1:]      // len(b)=4, cap(b)=4
</code></pre><h3 id="Slices-of-slices"><a href="#Slices-of-slices" class="headerlink" title="Slices of slices"></a>Slices of slices</h3><p>Slices可以包含任何类型，也可以包含其他的slices。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"strings"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Create a tic-tac-toe board.</span></div><div class="line">	board := [][]<span class="keyword">string</span>&#123;</div><div class="line">		[]<span class="keyword">string</span>&#123;<span class="string">"_"</span>, <span class="string">"_"</span>, <span class="string">"_"</span>&#125;,</div><div class="line">		[]<span class="keyword">string</span>&#123;<span class="string">"_"</span>, <span class="string">"_"</span>, <span class="string">"_"</span>&#125;,</div><div class="line">		[]<span class="keyword">string</span>&#123;<span class="string">"_"</span>, <span class="string">"_"</span>, <span class="string">"_"</span>&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// The players take turns.</span></div><div class="line">	board[<span class="number">0</span>][<span class="number">0</span>] = <span class="string">"X"</span></div><div class="line">	board[<span class="number">2</span>][<span class="number">2</span>] = <span class="string">"O"</span></div><div class="line">	board[<span class="number">1</span>][<span class="number">2</span>] = <span class="string">"X"</span></div><div class="line">	board[<span class="number">1</span>][<span class="number">0</span>] = <span class="string">"O"</span></div><div class="line">	board[<span class="number">0</span>][<span class="number">2</span>] = <span class="string">"X"</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(board); i++ &#123;</div><div class="line">		fmt.Printf(<span class="string">"%s\n"</span>, strings.Join(board[i], <span class="string">" "</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="向一个slice添加元素"><a href="#向一个slice添加元素" class="headerlink" title="向一个slice添加元素"></a>向一个slice添加元素</h3><p>追加一个新元素到slice是很普遍的，所以Go提供了一个<code>apend</code>方法：</p>
<pre><code>func append(s []T, vs ...T) []T
</code></pre><p>第一个参数<code>s</code>是一个slice，剩下的参数是追加到slice中的值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> s []<span class="keyword">int</span></div><div class="line">	printSlice(s)</div><div class="line"></div><div class="line">	<span class="comment">// append works on nil slices.</span></div><div class="line">	s = <span class="built_in">append</span>(s, <span class="number">0</span>)</div><div class="line">	printSlice(s)</div><div class="line"></div><div class="line">	<span class="comment">// The slice grows as needed.</span></div><div class="line">	s = <span class="built_in">append</span>(s, <span class="number">1</span>)</div><div class="line">	printSlice(s)</div><div class="line"></div><div class="line">	<span class="comment">// We can add more than one element at a time.</span></div><div class="line">	s = <span class="built_in">append</span>(s, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</div><div class="line">	printSlice(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"len=%d cap=%d %v\n"</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h3><p><code>for</code>循环的<code>range</code>格式可以迭代一个slice或map。</p>
<p>当rangey一个slice，每次迭代都会返回两个值，第一个是index，第二个是该index位置元素的副本。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> pow = []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i, v := <span class="keyword">range</span> pow &#123;</div><div class="line">		fmt.Printf(<span class="string">"2**%d = %d\n"</span>, i, v)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Range-continued"><a href="#Range-continued" class="headerlink" title="Range continued"></a>Range continued</h3><p>通过分配<code>_</code>来跳过index或value。</p>
<p>如果你仅仅只是需要index，去掉”, value”。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	pow := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> pow &#123;</div><div class="line">		pow[i] = <span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(i) <span class="comment">// == 2**i</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> _, value := <span class="keyword">range</span> pow &#123;</div><div class="line">		fmt.Printf(<span class="string">"%d\n"</span>, value)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>一个map是keys到value的映射。</p>
<p>map的零值是nil。nil的map没有keys，也不能添加key。</p>
<p><code>make</code>方法返回一个map。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123;</div><div class="line">	Lat, Long <span class="keyword">float64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">string</span>]Vertex</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]Vertex)</div><div class="line">	m[<span class="string">"Bell Labs"</span>] = Vertex&#123;</div><div class="line">		<span class="number">40.68433</span>, <span class="number">-74.39967</span>,</div><div class="line">	&#125;</div><div class="line">	fmt.Println(m[<span class="string">"Bell Labs"</span>])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Map操作"><a href="#Map操作" class="headerlink" title="Map操作"></a>Map操作</h3><p>插入或更新map中的一个元素：</p>
<pre><code>m[key] = elem
</code></pre><p>获取一个元素：</p>
<pre><code>elem = m[key]
</code></pre><p>删除一个元素：</p>
<pre><code>delete(m, key)
</code></pre><p>测试一个key是否存在：</p>
<pre><code>elem, ok = m[key]
</code></pre><p>如果key存在，ok为true，如果不存在，ok为false。</p>
<p>如果key不存在，elem为零值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>)</div><div class="line"></div><div class="line">	m[<span class="string">"Answer"</span>] = <span class="number">42</span></div><div class="line">	fmt.Println(<span class="string">"The value:"</span>, m[<span class="string">"Answer"</span>])</div><div class="line"></div><div class="line">	m[<span class="string">"Answer"</span>] = <span class="number">48</span></div><div class="line">	fmt.Println(<span class="string">"The value:"</span>, m[<span class="string">"Answer"</span>])</div><div class="line"></div><div class="line">	<span class="built_in">delete</span>(m, <span class="string">"Answer"</span>)</div><div class="line">	fmt.Println(<span class="string">"The value:"</span>, m[<span class="string">"Answer"</span>])</div><div class="line"></div><div class="line">	v, ok := m[<span class="string">"Answer"</span>]</div><div class="line">	fmt.Println(<span class="string">"The value:"</span>, v, <span class="string">"Present?"</span>, ok)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="方法值"><a href="#方法值" class="headerlink" title="方法值"></a>方法值</h3><p>方法也是一个值。可以像其他值一样被传递。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"math"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">compute</span><span class="params">(fn <span class="keyword">func</span>(<span class="keyword">float64</span>, <span class="keyword">float64</span>)</span> <span class="title">float64</span>) <span class="title">float64</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fn(<span class="number">3</span>, <span class="number">4</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	hypot := <span class="function"><span class="keyword">func</span><span class="params">(x, y <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> math.Sqrt(x*x + y*y)</div><div class="line">	&#125;</div><div class="line">	fmt.Println(hypot(<span class="number">5</span>, <span class="number">12</span>))</div><div class="line"></div><div class="line">	fmt.Println(compute(hypot))</div><div class="line">	fmt.Println(compute(math.Pow))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>Go的方法可以是一个闭包，闭包是一个方法值，引用了方法体之外的值。这个方法可以读取和分配值给这个引用的变量。换句话说，方法被绑定在变量上。</p>
<p>如下的例子，<code>adder</code>方法返回一个闭包。每个闭包绑定在它自己的变量<code>sum</code>上。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">adder</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	sum := <span class="number">0</span></div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		sum += x</div><div class="line">		<span class="keyword">return</span> sum</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	pos, neg := adder(), adder()</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">		fmt.Println(</div><div class="line">			pos(i),</div><div class="line">			neg(<span class="number">-2</span>*i),</div><div class="line">		)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2016/12/28/raft-principle-implement-03/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/28/raft-principle-implement-03/" itemprop="url">
                  Raft原理与实现（三）：日志压缩
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-28T22:00:16+08:00">
                2016-12-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Raft原理与实现/" itemprop="url" rel="index">
                    <span itemprop="name">Raft原理与实现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/28/raft-principle-implement-03/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/28/raft-principle-implement-03/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这一节是要是日志压缩和客户端交互的部分，先略过。如果能实现一、二篇所描述的部分，再来实现本节。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2016/12/26/raft-principle-implement-02/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/26/raft-principle-implement-02/" itemprop="url">
                  Raft原理与实现（二）：安全性与成员变更
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-26T12:02:33+08:00">
                2016-12-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Raft原理与实现/" itemprop="url" rel="index">
                    <span itemprop="name">Raft原理与实现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/26/raft-principle-implement-02/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/26/raft-principle-implement-02/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Safety"><a href="#Safety" class="headerlink" title="Safety"></a>Safety</h2><p>之前的章节描述了Raft的leader选举和日志复制。但是如果按照之前的方式来，会有一些问题。比如说follower当选为leader之后可能会重写已经被commit的log，这样就会导致不同server的状态机执行了不同的command。</p>
<h3 id="Election-restriction"><a href="#Election-restriction" class="headerlink" title="Election restriction"></a>Election restriction</h3><p>Raft使用一个简单的方法，它保证了之前term的所有被committed entries，在新当选的leader都存在。</p>
<p>Raft在投票的过程中就保证了一个candidate赢得选举的条件是这个candidate必须包含所有被committed entries。为了赢得选举，candidate必须与集群中的大多数联系，这意味着每个被committed entry至少在这些大多数中的一台中存在。如果candidate的log和集群中的大多数比一样新或比他们更新，那么就可以认为这个candidate hold所有被committed entries。这个限制是通过The RequestVote RPC来实现的：</p>
<ul>
<li>RPC包含了candidate的log</li>
<li>如果voter发现自己的log比candidate的log 更新，就拒绝这个投票。</li>
</ul>
<p>Raft通过比较log中最新的entries的index和term来决定哪个更新。如果最新的entries有不同的term，则更大的term是更新的，如果有相同的term，谁的log更多，谁就是更新的。</p>
<h3 id="Committing-entries-from-previous-terms"><a href="#Committing-entries-from-previous-terms" class="headerlink" title="Committing entries from previous terms"></a>Committing entries from previous terms</h3><p>当entry被复制到集群中大多数的时候，leader就知道这个entry是committed。如果leader在committing一个entry的时候cash了，随后的leader将会尝试完成这个entry的复制。但是一个leader不能立即推断出一个之前的term的entry是否是committed，即使这个entry被保存在了集群中的大多数server中。</p>
<p>如下图就展示了这种情况：一个老的entry已经被保存在了大多数server中，但是仍然被后面的leader给重写了。</p>
<p><img src="/images/raft_safy_r.png" alt=""></p>
<p>如上图：</p>
<ul>
<li>在（a）中，S1当选为leader，然后在index=2复制了部分log entry。</li>
<li>在（b）中，S1宕机，S5获得了来自S3、S4和它自己的投票，然后当选为leader，并在index=2写入了一个不同的entry。</li>
<li>在（c）中，S5宕机，S1重启之后当选为leader，然后开始复制log entry。这时候，来自term=2的log已经被复制到了大多数机器中，但是它还没有被committed。</li>
<li>在（d）中，由于S1宕机，S5获得了来自 S2， S3和S4的投票，然后从term=3开始重写entry。</li>
<li>在（e）中，如果S1在宕机之前把当前term的一个entry复制到大多数server中，并且这个entry被提交，这时候S5就不可能赢得选举。在这个点，所有之前的entry也被提交。</li>
</ul>
<p>为了消除上图中这种情况，Raft永远不会通过副本数来commit之前term的log entries。只有当前term的log entries才会通过计算副本数被commit。并且一旦当前term的entriy被committed，根据 Log Matching Property，所有之前的log entries也会被提交。</p>
<h3 id="Safety-argument"><a href="#Safety-argument" class="headerlink" title="Safety argument"></a>Safety argument</h3><p>通过之前的选举和日志复制，然后再加上上面的限制。完整的Raft算法已经描述完了。现在来证明 Leader Completeness Property。</p>
<p>现在假设leader在term T 提交了一个当前term的log entry，但是这个log entry在随后的term没有被leader保存。</p>
<p>假设term U是大于term T的最小的term，并且term U的leader没有包含这个log entry。</p>
<ol>
<li>被提交的entry在leader U选举的时候肯定没有被保存在log中。因为leader不会删除或覆盖自己的log。</li>
<li>leader T把这个entry复制到集群中的大多数，并且leader U收到了来自集群中大多数server的投票。因此，至少有一个server（voter）收到了来自leader T的entry，并且给leader U投了票。像下图所示，这个server就是一个矛盾点。</li>
<li>voter必须在给leader U投票之前收到了被leader T提交的entry。否则它会拒绝来自leader T的AppendEntries请求，因为它当前的term比T的高。</li>
<li>当voter投票给leader U的时候，它仍然保存着这个entry。因为每个中间的leader都包含了这个entry，leader永远不会移除entries，并且follower只会移除和leader冲突的entries。</li>
<li>voter将票投给了leader U，所以leader U的log必须和voter至少是一样新的。这就导致了两个矛盾。</li>
<li>首先，如果voter和leader U有相同的最新的entry，leader U的log要至少和voter的log一样长，所以它的log包含了voter的log的每个entry。这就是一个矛盾。</li>
<li>leader U 最新的log entry的term必须大于voter的log entry。此外，它会大于T，因为voter的最新的log至少是T。</li>
<li>因此，假设不成立。</li>
</ol>
<p>大于T的leader的所有term必须包含了所有在term T被提交的entries。</p>
<p><img src="/images/raft_safy_02.png" alt=""></p>
<p>如上图，如果S1在当前term提交了一个新的log entry，对于随后的term U，S5被选为leader，这时候必须有一个S3接受了这个log entry，并且给S5投票。</p>
<h2 id="Cluster-membership-changes"><a href="#Cluster-membership-changes" class="headerlink" title="Cluster membership changes"></a>Cluster membership changes</h2><p>到目前为止，我们都假设集群中的server是固定的。但是在实际生产中，我们偶尔会变更集群配置，比如说替换到宕机的server。最简单的方式就是停掉整个集群，然后更新配置文件，然后重启集群，但是这会造成集群在短时间内不可用。</p>
<p>想要安全的更新配置文件，必须保证在集群转换期间的同一个term内不可能会出现两个leader。如下图，把配置文件直接替换成新的是不安全的，可能会出现两个leader。</p>
<p><img src="/images/raft_member_change_01.png" alt=""></p>
<p>为了确保安全，配置变更必须使用两阶段的方式。</p>
<p>在Raft中，集群首先转换到称为<em>joint consensus</em>的状态，一旦joint consensus被committed，系统就开始使用新的配置文件。</p>
<p>joint consensus将旧的和新的配置文件联系起来了：</p>
<ul>
<li>Log entries被复制到所有的集群中。包括新、旧配置文件。</li>
<li>来自任何一份配置总的server可能会是leader</li>
<li>对于选举和entry，都需要新和旧的多数派的同意。</li>
</ul>
<p>集群配置使用特殊的log entries来存储，当leader收到一个将C old转换到C new的请求的时候，它就作为joint consensus来保存这个配置，并使用之前的机制来复制该log entry。一旦一个server将new configuration增加到它的log之后，后面所有的决策，它就使用该configuration。这意味着leader使用C old,new来决定对于C old,new的log entry是否被提交。如果leader宕机，一个新的leader要么在C old，要么在C old,new下被选择。任何情况下，C new都不可能做出单边决议。</p>
<p>一旦C old,new被提交，只有C old,new的server才能被选举为leader。对于leader来说，现在创建一个C new并复制给server是安全的。当C new被提交之后，    现在就可以安全的下线新的配置中不存在的机器。如下图，任何时间点，C new 和 C old都不可以同时做出单边决议。</p>
<p><img src="/images/raft_member_change02.png" alt=""></p>
<p>如上图，leader首先创建C old,new ，被提交之后，再创建C new 然后把它提交到C new中的多数。在任意时间点，C old和 C new都不能同时独立的做出决议。</p>
<p>更新配置的时候，有三个主要的问题。</p>
<p>第一个问题是新的server可能没有初始化log entries。当他们加入集群的时候，需要花一段时间来追上最新的数据，在这段时间，它可能不会提交新的log entry。为了避免这个问题，Raft在配置变更前引入了一个新的阶段，新的server加入集群的时候，是作为一个non-voting成员，意思是leader仅仅是复制日志给他们，而不把他们作为大多数考虑。直到该server追上leader的log。</p>
<p>第二个问题是集群的leader可能并在新的配置中。在这种情况下，一旦它提交了C new，就主动下线。</p>
<p>第三个问题被移除的server可能会影响集群。这些被下线的机器不再受到心跳信息，然后他们开始了一轮选举。它们会发送RequestVote RPCs，并带上新的term，这会使leader转换到follower状态。一个新的leader会被选举出来，但是被移除的server又会time out，然后开始选举。为了解决这个问题，当这个server确信当前的leader存在的时候，server会忽视RequestVote RPCs。具体来说，如果一个server收到了当前leader的心跳之后的最小time out时间内收到了一个RequestVote RPC要求投票，它不会更新它的term，也不会进行投票。这不会影响正常的选举，因为每个server在选举之前至少等待最小 election timeout。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2016/12/21/raft-principle-implement-01/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/21/raft-principle-implement-01/" itemprop="url">
                  Raft原理与实现（一）：简介、选举与日志复制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-21T22:45:37+08:00">
                2016-12-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Raft原理与实现/" itemprop="url" rel="index">
                    <span itemprop="name">Raft原理与实现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/21/raft-principle-implement-01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/21/raft-principle-implement-01/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Raft是什么"><a href="#Raft是什么" class="headerlink" title="Raft是什么"></a>Raft是什么</h2><p>Raft是来管理复制日志的一个一致性协议。它和（multi-）Paxos有一样的效果，但是它的结构却和Paxos有所不同。简单点来说，它比Paxos更容易理解，也更容易实现。相信读过Paxos的读者已经体会过Paxos的晦涩、难懂，以及难以实现之处。而Raft直接提出了实现该协议的几个要素：leader选举、日志复制和安全性，甚至给出了伪代码。相比Paxos，Raft通过加强对状态一致性的约束来减少需要考虑的状态数目。</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>一致性算法允许一组机器一起工作来应对某些机器宕机。在过去十来年，Paxos一直在这方面占主导地位：许多实现都是基于Paxos，或受Paxos的影响。但是，Paxos实在是太难懂了，此外，还需要一些复杂的改变来支持实际的应用。</p>
<p>在与Paxos做了一番斗争之后，我们提出了一个新的一致性算法，这个算法就叫Raft，并且它的首先目标就是要容易理解。</p>
<p>Raft有几个特性：</p>
<ul>
<li>Strong leader：相比其他协议，Raft对leadership作出了更强的约束，比如说：日志只能从leader流向其他servers。</li>
<li>Leader election：Raft使用随机的时间来选举leader。</li>
<li>Membership changes：Raft使用了一个joint consensus方式来应对成员变更。这让整个集群在成员变更期间依然能提供服务。</li>
</ul>
<h2 id="Replicated-state-machines"><a href="#Replicated-state-machines" class="headerlink" title="Replicated state machines"></a>Replicated state machines</h2><p>在分布式系统中，使用Replicated state machines来解决各种各样的故障容错问题。</p>
<p>Replicated state machines使用replicated log来实现，每个server存储一系列的commands，这些commands将会被状态机有序执行。每个log都会以相同的顺序存储相同的command。</p>
<p>一致性算法是的工作就是保证replicated log的一致性。</p>
<p>对于一个实际的系统，一致性算法有下列属性：</p>
<ul>
<li>safety：不会返回一个错误的结果。</li>
<li>available： 大多数server可用的情况下，系统就是可用的。</li>
<li>不依赖时钟来确保log的一致性</li>
<li>当集群中的大多数机器能工作时，少数机器不会影响整个集群的性能。</li>
</ul>
<p>如下图，是一个Replicated state machines的结构：</p>
<p><img src="/images/raft_state_machine.png" alt=""></p>
<p>如图所示，一致性算法管理着一个 replicated log，该log包含了来自客户端的状态机命令。不同server的状态机都会从log中执行相同的command序列，所以会输出相同的结果。</p>
<h2 id="What’s-wrong-with-Paxos"><a href="#What’s-wrong-with-Paxos" class="headerlink" title="What’s wrong with Paxos?"></a>What’s wrong with Paxos?</h2><p>Paxos有两个主要的缺点：</p>
<ul>
<li>第一是Paxos实在是太难懂了。</li>
<li>第二是Paxos没有给一个工程实现提供基础。Lamport大师本人对multi-Paxos做了大概的描述，但缺少了很多细节。</li>
</ul>
<h2 id="Designing-for-understandability"><a href="#Designing-for-understandability" class="headerlink" title="Designing for understandability"></a>Designing for understandability</h2><p>Raft的几个目标：</p>
<ul>
<li>对于工程实现，提供完整的和实用基础。</li>
<li>安全性和可用性</li>
<li>高效性</li>
</ul>
<p>Raft还有一个最最重要的目标：<strong><em>understandability</em></strong>。</p>
<p>Raft采用了两种方式来让读者可理解：</p>
<ul>
<li>问题分解：比如说在Raft中有leader选举、log复制、safty和成员变更。</li>
<li>简化状态空间：减少要考虑的状态，比如说log不允许有日志空洞、</li>
</ul>
<h2 id="The-Raft-consensus-algorithm"><a href="#The-Raft-consensus-algorithm" class="headerlink" title="The Raft consensus algorithm"></a>The Raft consensus algorithm</h2><p>Raft首先选举出一个leader，然后让leader来管理复制日志。拥有leader极大的简化了复制日志管理。</p>
<p>通过leader的方式，Raft把一致性问题分解为三个独立的子问题：</p>
<ol>
<li>Leader election：必须有个leader。</li>
<li>Log replication：leader从客户端接受日志，并复制到集群中其他server上。</li>
<li>Safety：如果一个server应用了一个log entry到它的状态机中，对于相同的log index，其他的server不可能执行不同的command。</li>
</ol>
<h3 id="Raft-basics"><a href="#Raft-basics" class="headerlink" title="Raft basics"></a>Raft basics</h3><p>集群中的每个server只有三种状态：leader, follower, 或 candidate。正常情况下有一个唯一的leader，其他的server都是follower。follower只能响应leader或candidates的请求，leader处理所有的客户端请求，candidate是用来选举。下图展示了这几种状态之间的转换：</p>
<p><img src="/images/raft_state_transitions.png" alt=""></p>
<p>Raft将时间划分为term，如下图所示。</p>
<p><img src="/images/raft_term.png" alt=""></p>
<p>每个term以一次选举开始。如果一个candidate赢得了选举，它就作为剩下term的leader。</p>
<p>term是一个逻辑时钟，每个server都会存储当前的term number，当server之间交换信息的时候，当前的term会被带上。如果一个server的当前term小于其他的server，它就把当前term更新。如果一个candidate或leader发现它的term已经过期，就立刻转换为follower状态。如果一个server收到一个过时的term的请求，则会拒绝这个请求。</p>
<p>Raft使用RPC来互相交流，并且只需要两种RPC请求：</p>
<ol>
<li>RequestVote RPC：在选举的时候使用。</li>
<li>AppendEntries RPC：leader进行日志复制和心跳信息的时候使用。</li>
</ol>
<h3 id="Leader-election"><a href="#Leader-election" class="headerlink" title="Leader election"></a>Leader election</h3><p>Raft使用心跳机制来触发选举。当一个server启动的时候，它是follower状态，只要server从leader或candidate收到有效的RPC，它就一直保持这种状态。leader定时发送心跳信息给集群中的大多数。如果一个follower在 election timeout时间内没收到信息，它就认为leader宕机，并开始一轮新的选举。</p>
<p>当开始选举的时候，follower增加当前的term，然后转换到candidate状态。然后给自己投票，同时发出一个RequestVote RPC给集群中的其他机器。这个server会一直保持candidate状态，直到发生下列三件事中的一件事：</p>
<ol>
<li>该server赢得了选举</li>
<li>其他的server当选为leader</li>
<li>一段时间后还是没有选出leader</li>
</ol>
<p>如果一个candidate在当前term内赢得了集群中大多数的机器的投票，它就当选为leader。在一个给定的term，每个server最多只能投一票，并且按照先谁来救投给谁的原则进行投票。大多数原则保证了在一个term中，最多只能有一个candidate可以赢得选举。</p>
<p>如果在等待投票的时候，一个candidate从别的server收到一个AppendEntries RPC说它是leader，如果leader的term大于或等于当前server的term，该candidate就意识到这个leader是合法的，然后转换到follower状态。如果RPC中的term小于当前server的term，该candidate会拒绝这个PRC，并继续保持candidate状态。</p>
<p>第三种情况发生在一个candidate既没有赢得选举，也没有丢失选举的情况下：如果多个server同时成为了candidate，将不会有candidate赢得大多数。当发生这种情况的时候，每个candidate将会time out，然后开始一轮新的选举。注意的是，如果没有一些额外的措施，可能这种情况会一直重复下去。</p>
<p>Raft使用随机的election timeout来保证不会发生上诉情况。Raft的election time从一个固定区间中（如150-300ms）选择一个值，这样，大多数情况下，只有一个server会time out，然后它赢得选举，并在其他server time out之前发送心跳。</p>
<h3 id="Log-replication"><a href="#Log-replication" class="headerlink" title="Log replication"></a>Log replication</h3><p>一旦一个leader被选举出来，它就开始处理客户端请求。每个客户端请求都会包含一个被状态机执行的command。leader把这个command作为一个新的entry追加到log中，然后同时发送AppendEntries RPCs给其他的server来复制这个entry。当entry被安全的复制之后，leader就会把这个command应用于状态机，然后将执行结果返回给client。如果followers宕机或run slowly，或网络丢包的时候，leader会重试AppendEntries RPCs 直到所有的followers保存了所有的log entries。</p>
<p>Logs像下图一样被组织起来。</p>
<p><img src="/images/raft_log.png" alt=""></p>
<p>如图所示，Logs由entries组成，每个entry包含它被创建的term，还包含一个command。term用来检查log的不一致。每个log entry也包含一个整数index用来标识他在log中的位置。</p>
<p>leader来决定什么时候把一个log entry应用到状态机上是安全的，这样的entry被称为committed。Raft保证了committed entries是被持久化并最终被所有可用的状态机应用。一个log entry就被committed当创建这个log entry的leader把它复制到到集群中的大多数机器中的时候。这也会commit该leader的log中的之前的entries，包括了之前的leader创建的entries。leader追踪着它知道的已经被committed的entry的最大的index，并在之后的AppendEntries RPCs中带上这个index，一旦一个follower知道一个log entry已经被committed，它就把这个entry应用于状态机。</p>
<p>Raft设计了一种机制，来让不同的server中的log保持一致。</p>
<p>Raft维护了下列属性</p>
<p>a. 在不同的logs中，如果两个entries有相同的index和term，则它们保存了相同的command。<br>b. 如果在不同的log中，两个entries有相同的index和term，那么这些logs之前所有的entries也保持一致。</p>
<p>属性一通过下列条件保证：</p>
<ul>
<li>一个leader在一个给定的term中，一个log index最多只创建一个entry。</li>
<li>log entries永远不会改变它们在log中位置。</li>
</ul>
<p>属性二通过执行一个一致性检查来保证。</p>
<ul>
<li>当发送一个AppendEntries RPC的时候，leader会包含比这个最新的entries的前一个index和term。如果follower在它的log中没有发现相同的index和term，就会拒绝这个最新的entries。</li>
</ul>
<p>当一致性检查成功的时候，leader就会知道follower的log和它自己的log完全一致。</p>
<p>正常情况下，leader和follower中的log保持一致，但是当leader和follower cash的时候，会出现不一致的情况。</p>
<p>如下图，follower的log可能会和一个新的leader的log不一致。</p>
<p><img src="/images/raft_log_inconsistencies.png" alt=""></p>
<p>在Raft中，leader通过强制使follower复制它自己log的来处理这种不一致的情况。这意味着在follower logs中的冲突的entries会被重写。</p>
<p>为了让follower的日志和leader保持一致，Raft采取以下办法：</p>
<ul>
<li>leader找到最后一次两个log相同的点</li>
<li>然后删除那个点之后的日志，</li>
<li>并且发送给follower那个点之后leader的entries。</li>
</ul>
<p>上诉这些动作发生在一致性检查的过程中。leader保存了每个follower的nextIndex，这个index是leader发送给follower的下一个log entry的index。当一个leader开始当选的时候，它初始化所有的nextIndex为它自己的logs的最新一个index。如果一个follower的log和leader不一样，一致性检查会失败。当失败之后，leader会逐渐减少nextIndex，直到到达一个点，leader和lfollower的日志是一样的。这时候，会移出follower的冲突的entries，然后追加来自leader的log entries。</p>
<p>有了这个机制，leader就不需要采取别的动作来回复日志一致。它仅仅只是开始正常的操作，日志会自动变得一致，当一致性检查失败的时候，leader永远不会重写或者删除它自己的log entries。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zivyu.github.io/2016/12/16/plan-2017/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="DanDan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/jiqimao02.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="DanDan的学习笔记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="DanDan的学习笔记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/16/plan-2017/" itemprop="url">
                  一些想法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-16T13:57:06+08:00">
                2016-12-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/生活随笔/" itemprop="url" rel="index">
                    <span itemprop="name">生活随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/16/plan-2017/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/16/plan-2017/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>主要是2016年都快过完了，这几天晚上睡觉想了想，时间虽然飞快，但是每个月在干什么事情，心里还是有点谱。</p>
<h2 id="先说几件打脸的事情"><a href="#先说几件打脸的事情" class="headerlink" title="先说几件打脸的事情"></a>先说几件打脸的事情</h2><p>记得年初的时候，跟群里的null大神聊天，说了几件今年准备完成的大事：</p>
<ul>
<li><a href="https://docs.oracle.com/javase/specs/jvms/se7/html/" target="_blank" rel="external">Jvm规范</a> 过一遍</li>
<li>Java内存模型与线程规范，即<a href="http://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf" target="_blank" rel="external">JSR-133</a> 过一遍</li>
</ul>
<p>然后到年中的时候，对Paxos以及一些分布式的算法入了迷，然后又夸下海口：</p>
<ul>
<li>将Paxos工程化，写出demo</li>
<li>学习 <a href="https://pdos.csail.mit.edu/6.824/schedule.html" target="_blank" rel="external">Mit 6.824</a> 课程，能自己实现一个简单的k-v数据库</li>
<li>将<a href="https://msdn.microsoft.com/en-us/library/jj554200.aspx" target="_blank" rel="external">CQRS Journey</a> 过一遍</li>
</ul>
<p>现在看看，真是年少无知，初生牛犊不怕虎。</p>
<p>比如说paxos工程化，记得当时到处找资料，看论文，苦苦挣扎了有两三个星期之久，连hello world都没法下手，然后当时工作也比较忙，就慢慢放下这件事了。</p>
<p>当然这里面也有些比较客观的原因，由于都是工作之余的时间，碎片化比较严重，往往一篇论文需要花一个星期，甚至更多的时间才能看完，导致效率低下，久而久之一件事就会拖很久，然后就慢慢被遗忘了。</p>
<h2 id="现在正在做的事情"><a href="#现在正在做的事情" class="headerlink" title="现在正在做的事情"></a>现在正在做的事情</h2><p>鉴于之前脸被自己打得太厉害，现在就做太多承诺了，说说最近在做的事情。</p>
<p>由于工作原因，无意中接触到Raft，虽然之前一直都有听过，但是都没深入细节。那天看完Raft的Abstract，我的眼泪都要掉下来，Raft直接告诉我们，学不会Paxos，以及不能工程化Paxos，真的不是由于我们的智商原因，真的是因为Paxos太<sup>tm</sup>难了，Lamport大师本人也只是对multi-Paxos做了简单的描述，省略了很多细节。这时候Raft站了出来，直接说我这个简单，只要按照我这个步骤来，就能实现一个一致性的协议。Raft简化了Paxos，把一致性算法分为几个独立的阶段，描述了一些细节，甚至给出了伪代码实现。so，现在正在做的事情，就是对着Raft来实现一遍，写出可以运行的demo。</p>
<p>明年也有换工作的想法，除了实现Raft之外，也有在慢慢复习一些基础知识。争取明年能找个好工作吧。</p>
<h2 id="面试感想"><a href="#面试感想" class="headerlink" title="面试感想"></a>面试感想</h2><p>因为进行了一两次面试，和群里的小伙伴聊了下，首先得确定自己的发展方向，是深入技术呢，还是去深耕业务？总感觉现在的位置比较尴尬，技术向吧，沉淀不够。初一扯，还能说点东西出来，但是往深了去，还是欠缺很多东西。往业务向呢，因为在现在的公司基本没做过业务开发，所以对这更是不懂。所以的先确定自己的发展方向。</p>
<p>这几天睡觉也在想这个问题，觉得自己还是对分布式这块的技术比较有兴趣。虽然说可能工作中用不到，可能也看不到某些显著的成果，但求无愧于心吧。</p>
<h2 id="来年的打算"><a href="#来年的打算" class="headerlink" title="来年的打算"></a>来年的打算</h2><p>首先得找个好工作，然后将raft完成。后面先只做一件事，那就是学习Mit 6.824的课程，实现一个k-v存储系统。至于完成之后再做什么，我觉得还是先不要想那么多吧，免得到时候又被打脸。</p>
<p>就先说这么多吧。。。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/jiqimao02.png"
               alt="DanDan" />
          <p class="site-author-name" itemprop="name">DanDan</p>
          <p class="site-description motion-element" itemprop="description">爱生活，爱学习，爱旅行。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DanDan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zivyu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
